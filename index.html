<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ§§é€±çš®è†šç§‘</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="cat1.png">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Zen Maru Gothic"', 'sans-serif'] },
                    colors: { 
                        cute: { 
                            red: '#ff6b6b',      // ç³–æœç´…
                            dark: '#c92a2a',     // æ·±ç´…å­—
                            yellow: '#ffd43b',   // äº®å¥¶é»ƒ
                            cream: '#fff0f3',    // ç²‰ç™½åº•
                            bg: '#ff8787'        // èƒŒæ™¯ç´…
                        } 
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #ff8787; 
            /* æ–°å¹´å–œæ°£èƒŒæ™¯ï¼šåœ“é»è£é£¾ */
            background-image: radial-gradient(#ffffff 20%, transparent 20%), radial-gradient(#ffffff 20%, transparent 20%);
            background-color: #ff8787;
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
            background-image: radial-gradient(rgba(255,255,255,0.2) 2px, transparent 2px), radial-gradient(rgba(255,255,255,0.2) 2px, transparent 2px);
            color: #495057;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Zen Maru Gothic', sans-serif;
        }
        .card { 
            background: #ffffff; 
            border-radius: 2rem; 
            border: 4px solid #fff; 
            box-shadow: 0 6px 0 rgba(0,0,0,0.05), 0 10px 15px -3px rgba(0,0,0,0.1);
        }
        .btn-push { transition: all 0.1s; border-bottom: 5px solid rgba(0,0,0,0.15); }
        .btn-push:active { transform: translateY(3px); border-bottom: 0px solid transparent; }
        .input-box { background: #fff0f3; border: 2px solid #ffc9c9; border-radius: 1rem; text-align: center; font-weight: 900; transition: all 0.2s; color: #c92a2a; }
        .input-box:focus { border-color: #ff6b6b; background: #fff; outline: none; box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.2); }
        
        /* æœˆæ›†æ¨£å¼ */
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; border-radius: 0.5rem; position: relative; color: #881337; }
        .has-game { background-color: #fef3c7; color: #b45309; border: 2px solid #fbbf24; }
        .game-badge { position: absolute; -bottom: 4px; -right: 4px; background: #e11d48; color: white; width: 18px; height: 18px; font-size: 10px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; box-shadow: 0 2px 2px rgba(0,0,0,0.1); z-index: 10; }
        .today { border: 2px dashed #e11d48; }

        details > summary { list-style: none; cursor: pointer; }
        details[open] summary ~ * { animation: sweep .3s ease-in-out; }
        @keyframes sweep { 0% {opacity: 0; transform: translateY(-10px)} 100% {opacity: 1; transform: translateY(0)} }
        .modal-enter { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body class="min-h-screen flex flex-col pb-10">

    <!-- è®€å–é®ç½© (åƒ…åœ¨ä¸Šå‚³æ™‚é¡¯ç¤º) -->
    <div id="loading-overlay" class="fixed inset-0 z-[60] bg-cute-bg/95 backdrop-blur-sm flex flex-col items-center justify-center hidden">
        <div class="flex gap-3 mb-6 animate-bounce">
            <div class="w-14 h-20 bg-white rounded-xl border-4 border-cute-yellow shadow-xl flex items-center justify-center transform -rotate-6"><span class="text-4xl">ğŸ§§</span></div>
            <div class="w-14 h-20 bg-white rounded-xl border-4 border-cute-yellow shadow-xl flex items-center justify-center transform rotate-6" style="animation-delay: 0.1s;"><span class="text-4xl">ğŸ§¨</span></div>
            <div class="w-14 h-20 bg-white rounded-xl border-4 border-cute-yellow shadow-xl flex items-center justify-center transform -rotate-3" style="animation-delay: 0.2s;"><span class="text-4xl">ğŸ€„</span></div>
        </div>
        <h3 class="text-3xl font-black text-white tracking-widest drop-shadow-md">è³‡æ–™ä¸Šå‚³ä¸­</h3>
        <p class="text-cute-yellow text-sm font-bold mt-2 animate-pulse bg-white/20 px-4 py-1 rounded-full">è«‹ç¨å€™...</p>
    </div>

    <!-- ==================== View 1: å¤§å»³ (Lobby) ==================== -->
    <div id="view-lobby" class="flex-1 flex flex-col max-w-md mx-auto w-full hidden">
        
        <!-- é ‚éƒ¨ Banner (è¼ªæ’­åŠŸèƒ½) -->
        <div class="relative w-full h-[58vh] overflow-hidden group bg-white shadow-xl z-0" id="banner-carousel">
            
            <!-- åœ–ç‰‡ 1: é è¨­é¡¯ç¤º (opacity-100) -->
            <div class="banner-slide absolute inset-0 transition-opacity duration-1000 opacity-100">
                <img src="mahjong_bg.png" 
                     onerror="this.src='https://images.unsplash.com/photo-1595759604118-a08822588c27?q=80&w=1000&auto=format&fit=crop'" 
                     class="w-full h-full object-cover transform transition duration-1000" alt="å°é¢1">
            </div>

            <!-- åœ–ç‰‡ 2: é è¨­éš±è— (opacity-0) -->
            <!-- å¦‚æœæ‚¨æœ‰ç¬¬äºŒå¼µåœ–ï¼Œè«‹å‘½åç‚º mahjong_bg2.png -->
            <div class="banner-slide absolute inset-0 transition-opacity duration-1000 opacity-0">
                <img src="mahjong_bg2.png" 
                     onerror="this.src='https://images.unsplash.com/photo-1622396636133-74323dc4d905?q=80&w=1000&auto=format&fit=crop'" 
                     class="w-full h-full object-cover transform transition duration-1000" alt="å°é¢2">
            </div>

            <!-- æ¼¸å±¤é®ç½© (å›ºå®šåœ¨æœ€ä¸Šå±¤ï¼Œä¸éš¨åœ–ç‰‡è¼ªæ’­) -->
            <div class="absolute inset-0 bg-gradient-to-t from-cute-red/80 via-transparent to-transparent flex flex-col justify-end p-8 pb-24 z-10 pointer-events-none">
                <h1 class="text-5xl font-black text-white drop-shadow-lg mb-1 tracking-wider transform translate-y-2">é€±çš®è†šç§‘çœ‹è¨º</h1>
                <p class="text-cute-yellow text-sm font-bold flex items-center gap-2 mt-1 bg-black/20 backdrop-blur-sm px-3 py-1 rounded-full w-fit transform translate-y-2">
                    <span class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse"></span>
                    <span>é€±çš®è†šç§‘</span>
                </p>
            </div>
        </div>

        <!-- 1. é–‹å±€è¨­å®šå¡ç‰‡ (ä¸Šæµ®äº¤ç–Šè¨­è¨ˆ) -->
        <!-- -mt-20 è² é‚Šè·è®“å¡ç‰‡å¾€ä¸Šè“‹ä½åœ–ç‰‡ï¼Œrelative z-10 ç¢ºä¿å®ƒåœ¨åœ–ç‰‡ä¸Šé¢ -->
        <div class="relative z-10 px-4 -mt-20 pb-8">
            <div class="card p-5 space-y-4 shadow-2xl border-t-8 border-cute-yellow">
                <div class="flex justify-between items-end">
                    <h3 class="font-black text-cute-dark text-lg"><i class="fa-solid fa-users text-cute-red"></i> èª°è¦ç™¼è²¡ï¼Ÿ</h3>
                    <div class="text-xs font-bold text-cute-red/60 bg-cute-cream px-3 py-1.5 rounded-xl border border-cute-red/20">åº•: <input type="number" id="init-chips" value="1000" class="w-10 text-center bg-transparent outline-none text-cute-red font-black"></div>
                </div>
                
                <div class="grid grid-cols-4 gap-2" id="lobby-players">
                    <!-- JS ç”Ÿæˆ -->
                </div>

                <!-- æ–°å¢ç©å®¶æŒ‰éˆ• -->
                <button onclick="addNewPlayer()" class="w-full py-3 rounded-xl border-2 border-dashed border-cute-red/40 text-cute-red font-black bg-cute-cream/30 hover:bg-cute-cream hover:border-cute-red transition flex items-center justify-center gap-2 group active:scale-95 text-sm">
                    <span class="w-6 h-6 rounded-full bg-cute-red text-white flex items-center justify-center shadow-md group-hover:rotate-90 transition-transform text-xs">
                        <i class="fa-solid fa-plus"></i>
                    </span>
                    <span>æ–°å¢å¤¥ä¼´</span>
                </button>

                <div class="grid grid-cols-5 gap-3 pt-1">
                    <button onclick="startGame()" class="col-span-3 btn-push bg-cute-red text-white text-xl font-black py-4 rounded-2xl shadow-lg hover:brightness-110 flex items-center justify-center gap-2 transform transition hover:-translate-y-1">
                        <i class="fa-solid fa-play"></i> é–‹æ–°å±€
                    </button>
                    
                    <a href="stats.html" class="col-span-2 btn-push bg-cute-yellow text-cute-dark text-base font-black py-4 rounded-2xl shadow-md hover:brightness-105 flex items-center justify-center gap-1">
                        <i class="fa-solid fa-trophy"></i> æ’è¡Œ
                    </a>
                </div>
            </div>
            
            <p class="text-center text-white/60 text-[10px] font-bold tracking-widest mt-4 drop-shadow-sm">ğŸ§§ HAPPY NEW YEAR 2026 ğŸ§§</p>
        </div>
    </div>

    <!-- ==================== View 2: ç‰Œå±€é€²è¡Œä¸­ (Game) ==================== -->
    <div id="view-game" class="flex-1 flex flex-col hidden pb-24">
        <div class="bg-cute-red text-white px-4 py-3 shadow-md flex justify-between items-center sticky top-0 z-40">
            <div class="font-bold text-lg flex items-center gap-2">
                <span class="bg-white text-cute-red px-3 py-0.5 rounded-full text-sm font-black shadow-sm transform -rotate-1">ç¬¬ <span id="game-round-display">1</span> é†¬</span>
            </div>
            <button onclick="exitGame()" class="text-xs bg-black/20 px-3 py-1 rounded-full hover:bg-black/30 transition backdrop-blur-sm font-bold">
                <i class="fa-solid fa-right-from-bracket"></i> çµæŸ
            </button>
        </div>

        <div class="p-4 max-w-md mx-auto w-full space-y-4">
            <div id="history-container" class="space-y-2"></div>

            <div class="card p-5 relative border-4 border-cute-yellow">
                <div class="flex justify-between items-center mb-5">
                    <div class="bg-cute-yellow text-cute-dark text-xs font-black px-3 py-1 rounded-full shadow-sm transform rotate-1">æ­£åœ¨è¼¸å…¥...</div>
                    <button onclick="openTopUpModal()" class="bg-green-100 text-green-700 text-xs font-black px-3 py-1.5 rounded-full hover:bg-green-200 transition border border-green-200 flex items-center gap-1 shadow-sm">
                        <i class="fa-solid fa-money-bill-wave"></i> ç‘éŠ€å€Ÿè²¸
                    </button>
                </div>

                <div id="current-rows" class="space-y-5 mt-2"></div>

                <hr class="my-5 border-dashed border-cute-red/20">

                <div class="flex items-center justify-between">
                    <div class="text-sm font-black text-cute-dark">
                        <i class="fa-solid fa-sack-dollar text-cute-yellow text-xl mr-1"></i> å…¬åŸºé‡‘ç¸½é¡
                    </div>
                    <div class="flex items-center gap-2">
                        <span id="fund-diff" class="text-xs font-bold text-gray-400">è®Šå‹•: 0</span>
                        <input type="number" id="current-fund" placeholder="0" class="input-box w-28 h-14 text-3xl shadow-inner" oninput="calculate()">
                    </div>
                </div>
            </div>
            
            <p class="text-center text-white/50 text-xs mt-4 font-bold">
                <i class="fa-solid fa-hand-point-up"></i> é»æ“Šåå­—å¯æ›äºº
            </p>
        </div>

        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50">
            <div class="max-w-md mx-auto flex gap-3 items-center">
                <div id="check-sum" class="flex-1 bg-gray-100 rounded-2xl py-4 px-4 font-black text-center text-gray-400 text-xl transition-colors border-2 border-transparent">
                    <i class="fa-solid fa-scale-balanced mr-1"></i> <span>0</span>
                </div>
                <button id="submit-btn" onclick="submitRound()" disabled class="btn-push flex-[2] bg-cute-red text-white font-black py-4 rounded-2xl shadow-sm text-xl flex items-center justify-center gap-2 transition disabled:opacity-50 disabled:cursor-not-allowed">
                    ä¸Šå‚³æœ¬é†¬ <i class="fa-solid fa-cloud-arrow-up"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- å¢è³‡ Modal -->
    <div id="topup-modal" class="hidden fixed inset-0 z-50 flex items-end justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeTopUpModal()"></div>
        <div class="relative bg-white w-full max-w-sm rounded-t-[2.5rem] shadow-2xl modal-enter p-6 pb-10 border-t-8 border-green-400">
            <h3 class="text-xl font-black text-gray-800 mb-4 text-center">ğŸ’¸ ç±Œç¢¼ä¸å¤ äº†ï¼Ÿ</h3>
            <div class="space-y-4">
                <div><label class="block text-xs font-bold text-gray-400 mb-1 pl-2">èª°è¦å¢è²¸</label><select id="topup-player" class="w-full bg-gray-100 border-0 rounded-2xl px-4 py-3 font-bold text-gray-700 outline-none focus:ring-2 focus:ring-green-400"></select></div>
                <div><label class="block text-xs font-bold text-gray-400 mb-1 pl-2">è£œå¤šå°‘éŒ¢</label><input type="number" id="topup-amount" value="1000" class="w-full bg-gray-100 border-0 rounded-2xl px-4 py-3 font-black text-xl text-green-600 outline-none text-center focus:ring-2 focus:ring-green-400"></div>
                <button onclick="confirmTopUp()" class="btn-push w-full bg-green-500 text-white font-black py-4 rounded-2xl shadow-lg hover:bg-green-600 transition">ç¢ºå®šå¢è³‡</button>
            </div>
        </div>
    </div>

    <!-- æ›äºº/æ”¹å Modal -->
    <div id="sub-modal" class="hidden fixed inset-0 z-50 flex items-end justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeSubModal()"></div>
        <div class="relative bg-white w-full max-w-sm rounded-t-[2.5rem] shadow-2xl modal-enter p-6 pb-10 border-t-8 border-cute-yellow">
            <h3 class="text-xl font-black text-gray-800 mb-4 text-center">ğŸ”„ æ›äºº / æ”¹å</h3>
            
            <div class="space-y-5">
                <!-- é¡¯ç¤ºç›®å‰æ˜¯èª° -->
                <div class="text-center bg-gray-50 rounded-xl p-3">
                    <span class="text-xs text-gray-400 block mb-1">ç›®å‰ä½ç½®ç©å®¶</span>
                    <span id="sub-current-player" class="text-2xl font-black text-cute-red">???</span>
                </div>

                <!-- é¸æ“‡æ–°ç©å®¶ -->
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 pl-2">æ›¿æ›ç‚º</label>
                    <select id="sub-new-player" class="w-full bg-gray-100 border-0 rounded-2xl px-4 py-3 font-bold text-gray-700 outline-none focus:ring-2 focus:ring-cute-yellow text-lg"></select>
                </div>

                <!-- èµ·å§‹ç±Œç¢¼ -->
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1 pl-2">èµ·å§‹ç±Œç¢¼ (åƒ…æ›äººæ™‚ç”Ÿæ•ˆ)</label>
                    <input type="number" id="sub-base-chips" value="1000" class="w-full bg-gray-100 border-0 rounded-2xl px-4 py-3 font-black text-xl text-gray-600 outline-none text-center focus:ring-2 focus:ring-cute-yellow">
                </div>

                <!-- æŒ‰éˆ•å€ -->
                <div class="grid grid-cols-2 gap-3 pt-2">
                    <button onclick="confirmSubstitution('reset')" class="btn-push bg-cute-red text-white font-black py-4 rounded-2xl shadow-lg hover:brightness-110 flex flex-col items-center justify-center">
                        <span class="text-lg">ğŸ”€ æ›äººä¸Šæ¡Œ</span>
                        <span class="text-[10px] opacity-80 font-normal">é‡ç½®åˆ†æ•¸ & ç±Œç¢¼</span>
                    </button>
                    <button onclick="confirmSubstitution('keep')" class="btn-push bg-blue-400 text-white font-black py-4 rounded-2xl shadow-lg hover:brightness-110 flex flex-col items-center justify-center">
                        <span class="text-lg">âœï¸ ç´”ç²¹æ”¹å</span>
                        <span class="text-[10px] opacity-80 font-normal">ä¿ç•™æ‰€æœ‰ç´€éŒ„</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // â˜… ä½ çš„æ¸¬è©¦ç‰ˆ URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbxWOtO6F00m_OAu0zc1hzQn4F2BieA1ZXAF7Bv_8i5L5KfeN9kV07C_6JFH9DuJ_M4/exec';
        
        const DEFAULT_PLAYERS = ['Jialye', 'å°T', 'Aki', 'Bigi', 'Jocelyn', 'é™¢é•·'];
        let allPlayers = [...DEFAULT_PLAYERS]; // å­˜æ”¾æ‰€æœ‰ç©å®¶æ¸…å–®

        let gameState = { active: false, round: 1, baseChips: {}, baseFund: 0, history: [], topUps: {} };
        let editingPlayerName = null; // æš«å­˜æ­£åœ¨ç·¨è¼¯çš„ç©å®¶

        async function init() {
            // è¼‰å…¥éŠæˆ²ç‹€æ…‹
            const savedState = localStorage.getItem('mj_game_state');
            
            // è¼‰å…¥ç©å®¶æ¸…å–®
            const savedPlayers = localStorage.getItem('mj_all_players');
            if (savedPlayers) {
                allPlayers = JSON.parse(savedPlayers);
            }

            if (savedState) {
                gameState = JSON.parse(savedState);
                if (!gameState.topUps) gameState.topUps = {};
                if (gameState.active) { renderGameView(); return; }
            }
            showLobby();
            startBannerCarousel(); // å•Ÿå‹• Banner è¼ªæ’­
        }

        // ================= Banner Carousel =================
        function startBannerCarousel() {
            const slides = document.querySelectorAll('.banner-slide');
            if (slides.length < 2) return;
            
            let currentIndex = 0;
            
            setInterval(() => {
                // ç›®å‰é€™å¼µ -> éš±è—
                slides[currentIndex].classList.remove('opacity-100');
                slides[currentIndex].classList.add('opacity-0');
                
                // ä¸‹ä¸€å¼µ
                currentIndex = (currentIndex + 1) % slides.length;
                
                // ä¸‹ä¸€å¼µ -> é¡¯ç¤º
                slides[currentIndex].classList.remove('opacity-0');
                slides[currentIndex].classList.add('opacity-100');
            }, 4000); // 5000ms = 5ç§’åˆ‡æ›ä¸€æ¬¡
        }

        function showLobby() {
            document.getElementById('view-lobby').classList.remove('hidden');
            document.getElementById('view-game').classList.add('hidden');
            renderLobbyPlayers();
        }

        // æ–°å¢ç©å®¶åŠŸèƒ½
        function addNewPlayer() {
            const newName = prompt("è«‹è¼¸å…¥æ–°ç©å®¶çš„åå­—ï¼š");
            if (newName && newName.trim() !== "") {
                const name = newName.trim();
                if (allPlayers.includes(name)) {
                    alert("é€™å€‹åå­—å·²ç¶“åœ¨æ¸…å–®è£¡å›‰ï¼");
                    return;
                }
                allPlayers.push(name);
                localStorage.setItem('mj_all_players', JSON.stringify(allPlayers));
                renderLobbyPlayers(); // é‡æ–°æ¸²æŸ“ä¸‹æ‹‰é¸å–®
                alert(`æ­¡è¿ ${name} åŠ å…¥ï¼`);
            }
        }

        function renderLobbyPlayers() {
            const container = document.getElementById('lobby-players');
            // é€™è£¡ç¢ºä¿ lastPlayers è£¡çš„åå­—å¦‚æœä¸åœ¨ allPlayers è£¡ï¼Œé‚„æ˜¯èƒ½é¡¯ç¤ºï¼ˆé›–ç„¶æ­£å¸¸ä¾†èªªæ‡‰è©²åœ¨ï¼‰
            let lastPlayers = JSON.parse(localStorage.getItem('mj_last_players')) || DEFAULT_PLAYERS.slice(0, 4);
            
            container.innerHTML = Array(4).fill(0).map((_, i) => {
                const currentPlayer = lastPlayers[i] || allPlayers[0]; // é˜²å‘†
                
                // ç”¢ç”Ÿé¸é …ï¼Œä½¿ç”¨ allPlayers
                const options = allPlayers.map(p => `<option value="${p}" ${p === currentPlayer ? 'selected' : ''}>${p}</option>`).join('');
                
                return `
                <div class="relative group">
                    <div class="w-full aspect-square bg-cute-cream rounded-2xl border-2 border-cute-red/20 flex flex-col items-center justify-center relative overflow-hidden group-hover:border-cute-red transition shadow-sm active:scale-95">
                        <div class="w-10 h-10 rounded-full bg-cute-red text-white flex items-center justify-center text-lg font-black mb-1 shadow-md border-2 border-white">
                            ${currentPlayer.charAt(0)}
                        </div>
                        <select onchange="updateLobbyPlayer(this, ${i})" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full text-center">${options}</select>
                        <span class="text-xs font-bold text-cute-dark pointer-events-none player-name-display">${currentPlayer}</span>
                        <i class="fa-solid fa-caret-down text-[10px] text-cute-red/30 absolute bottom-1"></i>
                    </div>
                </div>`;
            }).join('');
        }
        function updateLobbyPlayer(select, index) {
            const displayEl = select.parentElement.querySelector('.player-name-display');
            displayEl.innerText = select.value;
            const avatarEl = select.parentElement.querySelector('div');
            avatarEl.innerText = select.value.charAt(0);
            let lastPlayers = JSON.parse(localStorage.getItem('mj_last_players')) || DEFAULT_PLAYERS.slice(0, 4);
            lastPlayers[index] = select.value;
            localStorage.setItem('mj_last_players', JSON.stringify(lastPlayers));
        }

        // ================= éŠæˆ²æ ¸å¿ƒé‚è¼¯ =================
        function startGame() {
            const selects = document.querySelectorAll('#lobby-players select');
            const pList = Array.from(selects).map(s => s.value);
            if (new Set(pList).size !== 4) { alert("ç©å®¶ä¸èƒ½é‡è¤‡å–”ï¼"); return; }
            const initChips = parseInt(document.getElementById('init-chips').value) || 1000;

            gameState.active = true;
            gameState.round = 1; 
            gameState.players = pList;
            gameState.baseChips = {};
            gameState.topUps = {}; 
            pList.forEach(p => gameState.baseChips[p] = initChips);
            gameState.baseFund = 0;
            gameState.history = [];

            localStorage.setItem('mj_last_players', JSON.stringify(pList));
            saveState();
            renderGameView();
        }

        function renderGameView() {
            document.getElementById('view-lobby').classList.add('hidden');
            document.getElementById('view-game').classList.remove('hidden');
            document.getElementById('game-round-display').innerText = gameState.round;
            renderHistory();

            const container = document.getElementById('current-rows');
            container.innerHTML = gameState.players.map(p => {
                const lastVal = gameState.baseChips[p];
                const topUpVal = gameState.topUps[p] || 0;
                const effectiveBase = lastVal + topUpVal;
                const topUpBadge = topUpVal > 0 ? `<span onclick="modifyTopUp('${p}')" class="ml-1 text-[10px] text-green-600 bg-green-100 px-1 rounded font-bold cursor-pointer hover:bg-green-200 border border-transparent hover:border-green-300">ğŸ’°+${topUpVal}</span>` : '';

                // â˜…â˜…â˜… é€™è£¡ä¹Ÿè£œä¸Šå¯æ„›çš„é ­åƒ â˜…â˜…â˜…
                return `
                <div class="flex items-center justify-between player-row" data-name="${p}">
                    <div class="flex-1 flex items-center gap-3">
                        <div class="w-12 h-12 rounded-full bg-cute-yellow text-cute-dark flex items-center justify-center font-black text-xl border-4 border-white shadow-sm shrink-0">
                            ${p.charAt(0)}
                        </div>
                        <div>
                            <div onclick="openSubModal('${p}')" class="font-black text-lg text-cute-dark cursor-pointer hover:text-cute-red transition flex items-center gap-2">
                                ${p} <i class="fa-solid fa-pen-to-square text-xs text-gray-300"></i>
                            </div>
                            <div class="text-xs text-cute-dark/50 font-bold flex items-center">ä¸Šå±€: ${lastVal} ${topUpBadge}</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <div class="text-sm font-bold text-gray-400 w-12 text-right score-diff">0</div>
                        <input type="number" class="chip-input input-box w-24 h-12 text-2xl" 
                               value="${effectiveBase}" placeholder="${effectiveBase}" oninput="calculate()" onfocus="this.select()">
                    </div>
                </div>`;
            }).join('');
            document.getElementById('current-fund').value = gameState.baseFund;
            calculate();
        }

        // === æ›äºº/æ”¹å Modal é‚è¼¯ ===
        function openSubModal(currentPlayerName) {
            editingPlayerName = currentPlayerName;
            document.getElementById('sub-current-player').innerText = currentPlayerName;
            
            // ç”¢ç”Ÿä¸‹æ‹‰é¸å–®ï¼šæ’é™¤æ‰ç›®å‰ã€Œæ­£åœ¨æ¡Œä¸Šã€çš„å…¶ä»–ç©å®¶ (é¿å…é‡è¤‡é¸äºº)
            const activePlayers = gameState.players.filter(p => p !== currentPlayerName);
            const availablePlayers = allPlayers.filter(p => !activePlayers.includes(p));

            const select = document.getElementById('sub-new-player');
            select.innerHTML = availablePlayers.map(p => 
                `<option value="${p}" ${p === currentPlayerName ? 'selected' : ''}>${p}</option>`
            ).join('');

            // å¦‚æœé¸å–®è£¡æ²’æœ‰ç›®å‰é€™å€‹äºº (ä¾‹å¦‚æ˜¯æ‰‹å‹•è¼¸å…¥çš„)ï¼Œå°±æŠŠä»–åŠ å›å»é¸å–®ä¸¦é¸å–
            if (!availablePlayers.includes(currentPlayerName)) {
                const opt = document.createElement('option');
                opt.value = currentPlayerName;
                opt.text = currentPlayerName;
                opt.selected = true;
                select.add(opt);
            }

            document.getElementById('sub-modal').classList.remove('hidden');
        }

        function closeSubModal() {
            document.getElementById('sub-modal').classList.add('hidden');
            editingPlayerName = null;
        }

        function confirmSubstitution(mode) {
            const oldName = editingPlayerName;
            const newName = document.getElementById('sub-new-player').value;
            const newBaseChips = parseInt(document.getElementById('sub-base-chips').value) || 1000;

            if (!newName) return;
            
            // æ‰¾å‡ºä½ç½®
            const index = gameState.players.indexOf(oldName);
            if (index === -1) return;

            // æ›´æ–°åå­—
            gameState.players[index] = newName;

            if (mode === 'reset') {
                // æ¨¡å¼ï¼šæ›äººä¸Šæ¡Œ (é‡ç½®åˆ†æ•¸)
                delete gameState.baseChips[oldName];
                gameState.baseChips[newName] = newBaseChips;
                
                // ç§»é™¤èˆŠçš„å¢è³‡ï¼Œæ›æ–°äººå°±æ˜¯é‡æ–°é–‹å§‹
                if (gameState.topUps[oldName]) {
                    delete gameState.topUps[oldName];
                }
            } else {
                // æ¨¡å¼ï¼šç´”ç²¹æ”¹å (ç¹¼æ‰¿åˆ†æ•¸)
                gameState.baseChips[newName] = gameState.baseChips[oldName];
                delete gameState.baseChips[oldName];
                
                // ç¹¼æ‰¿å¢è³‡
                if (gameState.topUps[oldName]) {
                    gameState.topUps[newName] = gameState.topUps[oldName];
                    delete gameState.topUps[oldName];
                }
            }

            // å„²å­˜ä¸¦æ›´æ–°ç•«é¢
            localStorage.setItem('mj_last_players', JSON.stringify(gameState.players));
            saveState();
            renderGameView();
            closeSubModal();
        }

        function openTopUpModal() {
            const select = document.getElementById('topup-player');
            select.innerHTML = gameState.players.map(p => `<option value="${p}">${p}</option>`).join('');
            document.getElementById('topup-modal').classList.remove('hidden');
        }
        function closeTopUpModal() { document.getElementById('topup-modal').classList.add('hidden'); }
        function confirmTopUp() {
            const player = document.getElementById('topup-player').value;
            const amount = parseInt(document.getElementById('topup-amount').value) || 0;
            if (amount <= 0) return;
            if (!gameState.topUps[player]) gameState.topUps[player] = 0;
            gameState.topUps[player] += amount;
            saveState();
            closeTopUpModal();
            renderGameView(); 
        }
        function modifyTopUp(player) {
            const current = gameState.topUps[player] || 0;
            if (current === 0) return;
            const input = prompt(`ä¿®æ”¹ ${player} çš„å¢è³‡é‡‘é¡\n\nç›®å‰å¢è³‡: ${current}\n\nâ— è¼¸å…¥è² æ•¸å¯æ¸›å°‘ (ä¾‹å¦‚ -500)\nâ— è¼¸å…¥ 0 å¯å®Œå…¨ç§»é™¤`, "0");
            if (input === null) return; 
            const val = parseInt(input);
            if (!isNaN(val)) {
                if (val === 0) {
                    if (confirm(`ç¢ºå®šè¦å°‡ ${player} çš„å¢è³‡ (${current}) å…¨éƒ¨ç§»é™¤å—ï¼Ÿ`)) { gameState.topUps[player] = 0; }
                } else {
                    gameState.topUps[player] += val;
                    if (gameState.topUps[player] < 0) gameState.topUps[player] = 0;
                }
                saveState();
                renderGameView();
            } else { alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å­—"); }
        }

        function calculate() {
            const rows = document.querySelectorAll('.player-row');
            let totalScoreDiff = 0;
            rows.forEach(row => {
                const name = row.dataset.name;
                const base = gameState.baseChips[name];
                const topUp = gameState.topUps[name] || 0;
                const effectiveBase = base + topUp; 
                const currentInput = parseInt(row.querySelector('.chip-input').value);
                if (isNaN(currentInput)) { row.querySelector('.score-diff').innerText = '...'; return; }
                const diff = currentInput - effectiveBase;
                totalScoreDiff += diff;
                const diffEl = row.querySelector('.score-diff');
                diffEl.innerText = diff > 0 ? `+${diff}` : diff;
                diffEl.className = `text-sm font-bold w-12 text-right score-diff ${diff > 0 ? 'text-cute-red' : (diff < 0 ? 'text-green-600' : 'text-gray-300')}`;
            });
            const fundInput = document.getElementById('current-fund');
            const currentFund = parseInt(fundInput.value) || 0;
            const fundDiff = currentFund - gameState.baseFund;
            totalScoreDiff += fundDiff;
            document.getElementById('fund-diff').innerText = `è®Šå‹•: ${fundDiff > 0 ? '+' : ''}${fundDiff}`;
            const checkSumEl = document.getElementById('check-sum');
            const submitBtn = document.getElementById('submit-btn');
            checkSumEl.innerHTML = totalScoreDiff === 0 ? `<i class="fa-solid fa-check text-green-500"></i> <span class="text-green-600">å¸³ç›®å¹³è¡¡</span>` : `<i class="fa-solid fa-triangle-exclamation text-cute-red"></i> <span class="text-cute-red">${totalScoreDiff > 0 ? '+' : ''}${totalScoreDiff}</span>`;
            checkSumEl.className = `flex-1 rounded-2xl py-3 px-4 font-black text-center text-lg transition-colors border-2 ${totalScoreDiff === 0 ? 'bg-green-50 border-green-200' : 'bg-red-50 border-cute-red'}`;
            const allFilled = Array.from(document.querySelectorAll('.chip-input')).every(i => i.value !== '');
            if (totalScoreDiff === 0 && allFilled) {
                submitBtn.disabled = false;
                submitBtn.className = "btn-push flex-[2] bg-cute-red text-white font-black py-3 rounded-2xl shadow-lg hover:brightness-110 transition text-lg flex items-center justify-center gap-2 cursor-pointer border-b-4 border-yellow-700 active:border-b-0 active:translate-y-1";
            } else {
                submitBtn.disabled = true;
                submitBtn.className = "flex-[2] bg-gray-300 text-white font-black py-3 rounded-2xl shadow-sm text-lg flex items-center justify-center gap-2 cursor-not-allowed";
            }
        }

        async function submitRound() {
            const btn = document.getElementById('submit-btn');
            const originalText = `ä¸Šå‚³æœ¬é†¬ <i class="fa-solid fa-cloud-arrow-up"></i>`;
            btn.disabled = true; btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> ä¸Šå‚³ä¸­...`;
            document.getElementById('loading-overlay').classList.remove('hidden');
            const rows = document.querySelectorAll('.player-row');
            const payload = [];
            const nextBaseChips = {}; 
            rows.forEach(row => {
                const name = row.dataset.name;
                const base = gameState.baseChips[name];
                const topUp = gameState.topUps[name] || 0;
                const effectiveBase = base + topUp; 
                const current = parseInt(row.querySelector('.chip-input').value) || 0;
                const score = current - effectiveBase; 
                nextBaseChips[name] = current; 
                payload.push({ name: name, score: score, continuance: 0, penalty: 0, foul: 0, bigCount: 0, bigNames: "" });
            });
            const currentFund = parseInt(document.getElementById('current-fund').value) || 0;
            const fundDiff = currentFund - gameState.baseFund;
            try {
                const d = new Date();
                const dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                await fetch(API_URL, {
                    method: 'POST', mode: 'no-cors',
                    body: JSON.stringify({ date: dateStr, round: gameState.round, fund: fundDiff, data: payload })
                });
                gameState.history.push({ round: gameState.round, scores: payload, fund: fundDiff });
                gameState.round += 1;
                gameState.baseChips = nextBaseChips;
                gameState.baseFund = currentFund;
                gameState.topUps = {}; 
                saveState();
                renderGameView();
                document.getElementById('loading-overlay').classList.add('hidden');
                btn.innerHTML = originalText;
                btn.disabled = false;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (e) {
                alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
                btn.disabled = false;
                btn.innerHTML = originalText;
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        function renderHistory() {
            const container = document.getElementById('history-container');
            if (gameState.history.length === 0) { container.innerHTML = ''; return; }
            container.innerHTML = gameState.history.map((h, i) => {
                const winner = h.scores.reduce((prev, curr) => (prev.score > curr.score) ? prev : curr);
                const winnerText = winner.score > 0 ? `${winner.name} +${winner.score}` : 'å¹³å±€';
                return `<details class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden group"><summary class="flex justify-between items-center p-3 hover:bg-gray-50 transition select-none"><div class="font-bold text-gray-700 text-sm"><span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded text-xs mr-2">ç¬¬ ${h.round} é†¬</span><span class="text-cute-red">${winnerText}</span></div><i class="fa-solid fa-chevron-down text-gray-300 group-open:rotate-180 transition-transform"></i></summary><div class="p-3 bg-cute-cream/50 border-t border-gray-100 text-sm grid grid-cols-2 gap-2">${h.scores.map(s => `<div class="flex justify-between"><span class="text-gray-600">${s.name}</span><span class="font-bold ${s.score >= 0 ? 'text-cute-red' : 'text-green-600'}">${s.score > 0 ? '+' : ''}${s.score}</span></div>`).join('')}<div class="flex justify-between border-t border-gray-200 pt-1 mt-1 col-span-2"><span class="text-gray-500">å…¬åŸºé‡‘è®Šå‹•</span><span class="font-bold text-cute-yellow">${h.fund > 0 ? '+' : ''}${h.fund}</span></div></div></details>`;
            }).reverse().join('');
        }

        function saveState() { localStorage.setItem('mj_game_state', JSON.stringify(gameState)); }
        function exitGame() { if(confirm('ç¢ºå®šè¦çµæŸç›®å‰çš„ç‰Œå±€å—ï¼Ÿ\n(å°‡æœƒæ¸…é™¤ç›®å‰çš„æ‰‹æ©Ÿç´€éŒ„å›åˆ°å¤§å»³)')) { localStorage.removeItem('mj_game_state'); location.reload(); } }

        init();
    </script>
</body>
</html>