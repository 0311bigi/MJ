<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éº»å°‡é¤</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ff8787">
    <link rel="icon" href="cute.png">	
    <link rel="apple-touch-icon" href="cute.png">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['"Zen Maru Gothic"', 'sans-serif'] },
                    colors: { 
                        cute: { 
                            red: '#ff6b6b',       // ç³–æœç´…
                            dark: '#c92a2a',      // æ·±ç´…å­—
                            yellow: '#ffd43b',    // äº®å¥¶é»ƒ
                            cream: '#fff0f3',     // ç²‰ç™½åº•
                            bg: '#ff8787'         // èƒŒæ™¯ç´…
                        } 
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background-color: #ff8787; 
            background-image: radial-gradient(rgba(255,255,255,0.2) 2px, transparent 2px), radial-gradient(rgba(255,255,255,0.2) 2px, transparent 2px);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
            color: #495057;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Zen Maru Gothic', sans-serif;
            font-size: 16px; /* åŸºç¤å­—é«”åŠ å¤§ */
        }
        .card { 
            background: #ffffff; 
            border-radius: 2rem; 
            border: 4px solid #fff; 
            box-shadow: 0 6px 0 rgba(0,0,0,0.05), 0 10px 15px -3px rgba(0,0,0,0.1);
        }
        .btn-push { transition: all 0.1s; border-bottom: 5px solid rgba(0,0,0,0.15); }
        .btn-push:active { transform: translateY(3px); border-bottom: 0px solid transparent; }
        .input-box { background: #fff0f3; border: 2px solid #ffc9c9; border-radius: 1rem; text-align: center; font-weight: 900; transition: all 0.2s; color: #c92a2a; }
        .input-box:focus { border-color: #ff6b6b; background: #fff; outline: none; box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.2); }
        .modal-enter { animation: slideUp 0.3s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .big-hand-checkbox:checked + div { background-color: #ff6b6b; color: white; border-color: #ff6b6b; }
    </style>
</head>
<body class="min-h-screen flex flex-col pb-10">

    <!-- è®€å–é®ç½© -->
    <div id="loading-overlay" class="fixed inset-0 z-[60] bg-cute-bg/95 backdrop-blur-sm flex flex-col items-center justify-center hidden">
        <div class="flex gap-3 mb-6 animate-bounce">
            <div class="w-16 h-24 bg-white rounded-xl border-4 border-cute-yellow shadow-xl flex items-center justify-center transform -rotate-6"><span class="text-5xl">ğŸ±</span></div>
            <div class="w-16 h-24 bg-white rounded-xl border-4 border-cute-yellow shadow-xl flex items-center justify-center transform rotate-6" style="animation-delay: 0.1s;"><span class="text-5xl">ğŸ€„</span></div>
            <div class="w-16 h-24 bg-white rounded-xl border-4 border-cute-yellow shadow-xl flex items-center justify-center transform -rotate-3" style="animation-delay: 0.2s;"><span class="text-5xl">ğŸ§§</span></div>
        </div>
        <h3 class="text-4xl font-black text-white tracking-widest drop-shadow-md">è³‡æ–™åŒæ­¥ä¸­</h3>
        <p id="loading-text" class="text-cute-yellow text-base font-bold mt-2 animate-pulse bg-white/20 px-6 py-2 rounded-full">è«‹ç¨å€™...</p>
    </div>

    <!-- ==================== View 1: å¤§å»³ (Lobby) ==================== -->
    <div id="view-lobby" class="flex-1 flex flex-col max-w-md mx-auto w-full hidden">
        <div class="relative w-full h-[58vh] overflow-hidden group bg-white shadow-xl z-0" id="banner-carousel">
            
            <!-- Banner 1 -->
            <div class="banner-slide absolute inset-0 transition-opacity duration-1000 opacity-100">
                <img src="mahjong_bg.png" onerror="this.src='https://images.unsplash.com/photo-1595759604118-a08822588c27?q=80&w=1000&auto=format&fit=crop'" class="w-full h-full object-cover transform transition duration-1000">
            </div>

            <!-- Banner 2 -->
            <div class="banner-slide absolute inset-0 transition-opacity duration-1000 opacity-0">
                <img src="mahjong_bg2.png" onerror="this.src='https://images.unsplash.com/photo-1622396636133-74323dc4d905?q=80&w=1000&auto=format&fit=crop'" class="w-full h-full object-cover transform transition duration-1000">
            </div>

            <div class="absolute inset-0 bg-gradient-to-t from-cute-red/80 via-transparent to-transparent flex flex-col justify-end p-8 pb-24 z-10 pointer-events-none">
                <h1 class="text-5xl font-black text-white drop-shadow-lg mb-2 tracking-wider transform translate-y-2">èª°æ˜¯é›€å</h1>
                <p class="text-cute-yellow text-base font-bold flex items-center gap-2 mt-1 bg-black/20 backdrop-blur-sm px-4 py-1.5 rounded-full w-fit transform translate-y-2">
                    <span class="w-3 h-3 rounded-full bg-yellow-400 animate-pulse"></span><span>é–‹æ‰“</span>
                </p>
            </div>
        </div>
        <div class="relative z-10 px-4 -mt-20 pb-8">
            <div class="card p-6 space-y-5 shadow-2xl border-t-8 border-cute-yellow">
                <div class="flex justify-between items-end">
                    <h3 class="font-black text-cute-dark text-xl"><i class="fa-solid fa-users text-cute-red"></i> èª°è¦ç™¼è²¡ï¼Ÿ</h3>
                    <div class="text-sm font-bold text-cute-red/60 bg-cute-cream px-4 py-2 rounded-xl border border-cute-red/20">åº•: <input type="number" id="init-chips" value="1000" class="w-12 text-center bg-transparent outline-none text-cute-red font-black text-lg"></div>
                </div>
                <div class="grid grid-cols-4 gap-3" id="lobby-players"></div>
                <button onclick="addNewPlayer()" class="w-full py-4 rounded-xl border-2 border-dashed border-cute-red/40 text-cute-red font-black bg-cute-cream/30 hover:bg-cute-cream hover:border-cute-red transition flex items-center justify-center gap-2 group active:scale-95 text-base">
                    <span class="w-7 h-7 rounded-full bg-cute-red text-white flex items-center justify-center shadow-md group-hover:rotate-90 transition-transform text-sm"><i class="fa-solid fa-plus"></i></span><span>æ–°å¢å¤¥ä¼´</span>
                </button>
                <div class="grid grid-cols-5 gap-3 pt-2">
                    <button onclick="startGame()" class="col-span-3 btn-push bg-cute-red text-white text-2xl font-black py-5 rounded-2xl shadow-lg hover:brightness-110 flex items-center justify-center gap-2 transform transition hover:-translate-y-1"><i class="fa-solid fa-play"></i> é–‹æ–°å±€</button>
                    <!-- ä¿®æ”¹ï¼šç›´æ¥é€£çµåˆ° stats.html -->
                    <a href="stats.html" class="col-span-2 btn-push bg-cute-yellow text-cute-dark text-lg font-black py-5 rounded-2xl shadow-md hover:brightness-105 flex items-center justify-center gap-1 no-underline"><i class="fa-solid fa-chart-pie"></i> æ’è¡Œæ¦œ</a>
                </div>
            </div>
            <p class="text-center text-white/60 text-xs font-bold tracking-widest mt-6 drop-shadow-sm">ğŸ§§ HAPPY NEW YEAR 2026 ğŸ§§</p>
        </div>
    </div>

    <!-- ==================== View 2: ç‰Œå±€ (Game) ==================== -->
    <div id="view-game" class="flex-1 flex flex-col hidden pb-28">
        <div class="bg-cute-red text-white px-5 py-4 shadow-md flex justify-between items-center sticky top-0 z-40">
            <div class="font-bold text-xl flex items-center gap-2"><span class="bg-white text-cute-red px-4 py-1 rounded-full text-base font-black shadow-sm transform -rotate-1">ç¬¬ <span id="game-round-display">1</span> é†¬</span></div>
            <button onclick="exitGame()" class="text-sm bg-black/20 px-4 py-2 rounded-full hover:bg-black/30 transition backdrop-blur-sm font-bold"><i class="fa-solid fa-right-from-bracket"></i> çµæŸ</button>
        </div>
        <div class="p-4 max-w-md mx-auto w-full space-y-4">
            <div id="history-container" class="space-y-3"></div>
            
            <div class="card p-5 relative border-4 border-cute-yellow bg-white/90">
                <div class="flex justify-between items-center mb-5">
                    <div class="bg-cute-yellow text-cute-dark text-sm font-black px-4 py-1.5 rounded-full shadow-sm transform rotate-1">æ­£åœ¨è¼¸å…¥...</div>
                    <button onclick="openTopUpModal()" class="bg-green-100 text-green-700 text-sm font-black px-4 py-2 rounded-full hover:bg-green-200 transition border border-green-200 flex items-center gap-1 shadow-sm"><i class="fa-solid fa-money-bill-wave"></i> ç‘éŠ€å¢è²¸</button>
                </div>

                <div id="current-rows" class="space-y-5"></div>

                <hr class="my-6 border-dashed border-cute-red/20">
                <div class="flex items-center justify-between">
                    <div class="text-base font-black text-cute-dark"><i class="fa-solid fa-sack-dollar text-cute-yellow text-2xl mr-2"></i> å…¬åŸºé‡‘ç¸½é¡</div>
                    <div class="flex items-center gap-2"><span id="fund-diff" class="text-sm font-bold text-gray-400">è®Šå‹•: 0</span><input type="number" id="current-fund" placeholder="0" class="input-box w-32 h-14 text-3xl shadow-inner" oninput="calculate()"></div>
                </div>
            </div>
            
            <p class="text-center text-white/50 text-sm mt-4 font-bold"><i class="fa-solid fa-hand-point-up"></i> é»æ“Šåå­—å¯æ›äºº</p>
        </div>
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-5 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50">
            <div class="max-w-md mx-auto flex gap-4 items-center">
                <div id="check-sum" class="flex-1 bg-gray-100 rounded-2xl py-4 px-4 font-black text-center text-gray-400 text-2xl transition-colors border-2 border-transparent"><i class="fa-solid fa-scale-balanced mr-1"></i> <span>0</span></div>
                <button id="submit-btn" onclick="submitRound()" disabled class="btn-push flex-[2] bg-cute-red text-white font-black py-4 rounded-2xl shadow-sm text-2xl flex items-center justify-center gap-2 transition disabled:opacity-50 disabled:cursor-not-allowed">ä¸Šå‚³æœ¬é†¬ <i class="fa-solid fa-cloud-arrow-up"></i></button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- çµæŸç¢ºèª Modal (æ–°å¢) -->
    <div id="exit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeExitModal()"></div>
        <div class="relative bg-white w-full max-w-sm rounded-2xl p-6 border-4 border-cute-red m-4 modal-enter shadow-2xl">
            <h3 class="text-2xl font-black text-gray-800 mb-4 text-center">âš ï¸ çµæŸç‰Œå±€</h3>
            <p class="text-gray-600 font-bold text-center mb-6 text-lg">ç¢ºå®šè¦çµæŸç›®å‰çš„ç‰Œå±€å—ï¼Ÿ<br><span class="text-cute-red text-sm">(å°‡æœƒæ¸…é™¤æ‰‹æ©Ÿä¸Šçš„æš«å­˜ç´€éŒ„)</span></p>
            <div class="grid grid-cols-2 gap-4">
                <button onclick="closeExitModal()" class="btn-push bg-gray-400 text-white font-black py-4 rounded-xl text-lg shadow-lg">å–æ¶ˆ</button>
                <button onclick="confirmExit()" class="btn-push bg-cute-red text-white font-black py-4 rounded-xl text-lg shadow-lg">ç¢ºå®šçµæŸ</button>
            </div>
        </div>
    </div>

    <!-- ç‘éŠ€å¢è²¸ Modal -->
    <div id="topup-modal" class="hidden fixed inset-0 z-50 flex items-end justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeTopUpModal()"></div>
        <div class="relative bg-white w-full max-w-sm rounded-t-[2.5rem] p-8 pb-12 border-t-8 border-green-400 modal-enter">
            <h3 class="text-2xl font-black text-gray-800 mb-6 text-center">ğŸ’¸ è³‡é‡‘ç®¡ç†</h3>
            <div class="space-y-5">
                <select id="topup-player" class="w-full bg-gray-100 rounded-2xl px-5 py-4 font-bold text-gray-700 outline-none text-xl"></select>
                <input type="number" id="topup-amount" value="1000" class="w-full bg-gray-100 rounded-2xl px-5 py-4 font-black text-center text-3xl outline-none">
                
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="confirmTopUp(1)" class="btn-push bg-green-500 text-white font-black py-5 rounded-2xl shadow-lg flex items-center justify-center gap-1 text-lg">
                        <i class="fa-solid fa-plus-circle"></i> å¢è²¸
                    </button>
                    <button onclick="confirmTopUp(-1)" class="btn-push bg-blue-400 text-white font-black py-5 rounded-2xl shadow-lg flex items-center justify-center gap-1 text-lg">
                        <i class="fa-solid fa-arrow-rotate-left"></i> é‚„æ¬¾
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- æ›äºº Modal -->
    <div id="sub-modal" class="hidden fixed inset-0 z-50 flex items-end justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeSubModal()"></div>
        <div class="relative bg-white w-full max-w-sm rounded-t-[2.5rem] p-8 pb-12 border-t-8 border-cute-yellow modal-enter">
            <h3 class="text-2xl font-black text-gray-800 mb-6 text-center">ğŸ”„ æ›äºº / æ”¹å</h3>
            <div class="space-y-6">
                <div class="text-center bg-gray-50 rounded-xl p-4"><span class="text-sm text-gray-400 block mb-1">ç›®å‰ä½ç½®</span><span id="sub-current-player" class="text-3xl font-black text-cute-red">???</span></div>
                <select id="sub-new-player" class="w-full bg-gray-100 rounded-2xl px-5 py-4 font-bold text-gray-700 outline-none text-2xl"></select>
                <div><label class="text-sm font-bold text-gray-400 pl-2">èµ·å§‹ç±Œç¢¼</label><input type="number" id="sub-base-chips" value="1000" class="w-full bg-gray-100 rounded-2xl px-5 py-4 font-black text-center text-3xl outline-none"></div>
                <div class="grid grid-cols-2 gap-4 pt-2">
                    <button onclick="confirmSubstitution('reset')" class="btn-push bg-cute-red text-white font-black py-5 rounded-2xl shadow-lg text-lg">ğŸ”€ æ›äººä¸Šæ¡Œ</button>
                    <button onclick="confirmSubstitution('keep')" class="btn-push bg-blue-400 text-white font-black py-5 rounded-2xl shadow-lg text-lg">âœï¸ ç´”ç²¹æ”¹å</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å¤§ç‰Œé¸æ“‡å™¨ -->
    <div id="big-hand-modal" class="hidden fixed inset-0 z-[70] flex items-end justify-center">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeBigHandModal()"></div>
        <div class="relative bg-white w-full max-w-sm rounded-t-[2.5rem] p-6 pb-12 border-t-8 border-yellow-400 modal-enter flex flex-col max-h-[85vh]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-black text-gray-800 flex items-center gap-2"><span class="text-3xl">ğŸ€„</span> é¸æ“‡å¤§ç‰Œ</h3>
                <span id="big-hand-player-name" class="bg-gray-100 px-4 py-1.5 rounded-full text-sm font-bold text-gray-500">Player</span>
            </div>
            <div id="big-types-container" class="grid grid-cols-2 gap-3 overflow-y-auto hide-scrollbar pb-4 flex-1"></div>
            <button onclick="closeBigHandModal()" class="btn-push w-full bg-yellow-400 text-white font-black py-4 rounded-2xl shadow-lg mt-4 text-xl">å®Œæˆé¸æ“‡</button>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyQUvM-ZS2pB4P6ccnfP2C9NnVTuPmHmEqu9nZ9uLv2UpEPF6DAJTKiNucduECm75M/exec';
        
        const DEFAULT_PLAYERS = ['Miffy', 'Yuri', 'Penny', 'Bigi', 'Jocelyn', 'Jilye'];
        let allPlayers = [...DEFAULT_PLAYERS]; 
        let configBigTypes = ["å¤©èƒ¡","å…«ä»™éæµ·","å­—ä¸€è‰²","ä¸ƒæ¶ä¸€", "Migi", "å¤§å››å–œ", "å°å››å–œ", "æ¸…ä¸€è‰²", "æ··ä¸€è‰²", "å¤§ä¸‰å…ƒ", "å°ä¸‰å…ƒ", "ç¢°ç¢°èƒ¡", "äº”æš—åˆ»", "å››æš—åˆ»"]; 

        let gameState = { active: false, round: 1, baseChips: {}, baseFund: 0, history: [], topUps: {}, extras: {} };
        
        let editingPlayerName = null; 
        let currentBigHandPlayer = null; 

        // --- Init ---
        async function init() {
            const savedState = localStorage.getItem('mj_game_state');
            const savedPlayers = localStorage.getItem('mj_all_players');
            const savedBigTypes = localStorage.getItem('mj_big_types');

            if (savedPlayers) allPlayers = JSON.parse(savedPlayers);
            if (savedBigTypes) configBigTypes = JSON.parse(savedBigTypes);

            if (savedState) {
                gameState = JSON.parse(savedState);
                if (!gameState.topUps) gameState.topUps = {};
                if (!gameState.extras) gameState.extras = {};
                
                if (!gameState.sessionDate) {
                    const d = new Date();
                    gameState.sessionDate = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                }

                if (gameState.active) { renderGameView(); }
            } else {
                showLobby();
            }
            
            startBannerCarousel();
            fetchConfig(); 
        }

        async function fetchConfig() {
            try {
                const res = await fetch(API_URL);
                const json = await res.json();
                
                if (json.status === 'success') {
                    if (json.bigTypes && Array.isArray(json.bigTypes)) {
                        configBigTypes = json.bigTypes;
                        localStorage.setItem('mj_big_types', JSON.stringify(configBigTypes));
                    }
                }
            } catch(e) { console.log("Fetch config failed, using cache"); }
        }

        // --- Game Logic ---
        function ensureExtras(player) {
            if (!gameState.extras[player]) {
                gameState.extras[player] = { penalty: 0, foul: 0, continuance: 0, bigHands: [] };
            }
        }

        function cyclePenalty(player) {
            ensureExtras(player);
            let val = gameState.extras[player].penalty;
            val = (val + 1) > 2 ? 0 : val + 1; 
            gameState.extras[player].penalty = val;
            saveState(); renderGameView();
        }

        function cycleFoul(player) {
            ensureExtras(player);
            let val = gameState.extras[player].foul;
            val = (val + 1) > 1 ? 0 : val + 1; 
            gameState.extras[player].foul = val;
            saveState(); renderGameView();
        }

        function updateContinuance(player, input) {
            ensureExtras(player);
            let val = parseInt(input.value);
            if(isNaN(val) || val < 0) val = 0;
            gameState.extras[player].continuance = val;
            saveState();
        }

        function openBigHandModal(player) {
            currentBigHandPlayer = player;
            ensureExtras(player);
            document.getElementById('big-hand-player-name').innerText = player;
            
            const container = document.getElementById('big-types-container');
            const currentHands = gameState.extras[player].bigHands || [];
            
            if(configBigTypes.length > 0) {
                container.innerHTML = configBigTypes.map(type => {
                    const checked = currentHands.includes(type) ? 'checked' : '';
                    return `
                        <label class="cursor-pointer relative h-full">
                            <input type="checkbox" class="big-hand-checkbox hidden" value="${type}" ${checked} onchange="toggleBigHand(this)">
                            <div class="bg-white border-2 border-gray-100 rounded-xl px-2 py-4 text-base font-bold text-gray-500 text-center transition hover:bg-gray-50 select-none h-full flex items-center justify-center">
                                ${type}
                            </div>
                        </label>
                    `;
                }).join('');
            } else {
                container.innerHTML = `<div class="text-sm text-gray-400 col-span-2 text-center">ç„¡å¤§ç‰Œè³‡æ–™</div>`;
            }
            document.getElementById('big-hand-modal').classList.remove('hidden');
        }

        function toggleBigHand(checkbox) {
            if(!currentBigHandPlayer) return;
            const val = checkbox.value;
            let hands = gameState.extras[currentBigHandPlayer].bigHands;
            if(checkbox.checked) {
                if(!hands.includes(val)) hands.push(val);
            } else {
                hands = hands.filter(x => x !== val);
            }
            gameState.extras[currentBigHandPlayer].bigHands = hands;
            saveState();
            renderGameView(); 
        }

        function closeBigHandModal() {
            document.getElementById('big-hand-modal').classList.add('hidden');
            currentBigHandPlayer = null;
        }

        function renderGameView() {
            document.getElementById('view-lobby').classList.add('hidden');
            document.getElementById('view-game').classList.remove('hidden');
            document.getElementById('game-round-display').innerText = gameState.round;
            renderHistory();

            const container = document.getElementById('current-rows');
            container.innerHTML = gameState.players.map(p => {
                const lastVal = gameState.baseChips[p];
                const topUpVal = gameState.topUps[p] || 0;
                const effectiveBase = lastVal + topUpVal;
                // å¦‚æœ topUpVal æ˜¯ 0 (é‚„æ¸…äº†)ï¼Œå°±ä¸é¡¯ç¤ºæ¨™ç±¤
                const topUpBadge = topUpVal !== 0 
                    ? `<span class="ml-1 text-xs ${topUpVal > 0 ? 'text-green-600 bg-green-100' : 'text-blue-600 bg-blue-100'} px-1.5 py-0.5 rounded font-bold">ğŸ’°${topUpVal > 0 ? '+' : ''}${topUpVal}</span>` 
                    : '';
                
                const ex = gameState.extras[p] || { penalty: 0, foul: 0, continuance: 0, bigHands: [] };
                
                const penClass = ex.penalty > 0 ? 'bg-orange-500 text-white border-orange-600' : 'bg-gray-100 text-gray-400 border-gray-200';
                const foulClass = ex.foul > 0 ? 'bg-red-500 text-white border-red-600' : 'bg-gray-100 text-gray-400 border-gray-200';
                const bigClass = ex.bigHands.length > 0 ? 'bg-yellow-400 text-white border-yellow-500' : 'bg-gray-100 text-gray-400 border-gray-200';
                
                const bigHandList = ex.bigHands.length > 0 
                    ? `<div class="col-span-4 flex flex-wrap gap-1 mt-1">
                        ${ex.bigHands.map(h => `<span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-md font-bold shadow-sm">ğŸ€„ ${h}</span>`).join('')}
                       </div>` 
                    : '';

                return `
                <div class="bg-white rounded-2xl p-4 border-2 border-gray-100 shadow-sm transition hover:border-gray-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex-1 flex items-center gap-3 overflow-hidden">
                            <div class="w-14 h-14 rounded-full bg-cute-yellow text-cute-dark flex items-center justify-center font-black text-2xl border-4 border-white shadow-sm shrink-0">
                                ${p.charAt(0)}
                            </div>
                            <div class="min-w-0">
                                <div onclick="openSubModal('${p}')" class="font-black text-xl text-cute-dark cursor-pointer hover:text-cute-red transition flex items-center gap-1 truncate">
                                    ${p} 
                                </div>
                                <div class="flex items-center gap-1 mt-0.5">
                                    <span class="text-sm text-cute-dark/50 font-bold">åº•:${lastVal}</span>
                                    ${topUpBadge}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 pl-2">
                            <div class="text-base font-bold text-gray-400 w-8 text-right score-diff">0</div>
                            <input type="number" class="chip-input input-box w-24 h-14 text-2xl shadow-inner border-2 border-gray-100 focus:border-cute-red" 
                                value="${effectiveBase}" placeholder="${effectiveBase}" oninput="calculate()" onfocus="this.select()">
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-2">
                        <div class="relative">
                            <span class="absolute left-2 top-1/2 -translate-y-1/2 text-sm font-bold text-gray-400 pointer-events-none">é€£</span>
                            <input type="number" value="${ex.continuance || ''}" placeholder="0" class="w-full bg-gray-50 border-2 border-gray-100 rounded-xl py-3 pl-7 pr-1 text-base font-black text-purple-600 outline-none focus:border-purple-300 text-center" oninput="updateContinuance('${p}', this)">
                        </div>
                        <button onclick="cyclePenalty('${p}')" class="w-full py-3 rounded-xl border-2 text-sm font-black shadow-sm active:scale-95 transition flex items-center justify-center gap-1 ${penClass}">
                            <span>ç›¸</span><span>${ex.penalty > 0 ? ex.penalty : ''}</span>
                        </button>
                        <button onclick="cycleFoul('${p}')" class="w-full py-3 rounded-xl border-2 text-sm font-black shadow-sm active:scale-95 transition flex items-center justify-center gap-1 ${foulClass}">
                            <span>è©</span><span>${ex.foul > 0 ? ex.foul : ''}</span>
                        </button>
                        <button onclick="openBigHandModal('${p}')" class="w-full py-3 rounded-xl border-2 text-sm font-black shadow-sm active:scale-95 transition flex items-center justify-center gap-1 ${bigClass}">
                            <span>ğŸ€„</span><span>${ex.bigHands.length > 0 ? ex.bigHands.length : ''}</span>
                        </button>
                        ${bigHandList}
                    </div>
                </div>`;
            }).join('');
            
            document.getElementById('current-fund').value = gameState.baseFund;
            calculate();
        }

        async function submitRound() {
            const btn = document.getElementById('submit-btn');
            const originalText = btn.innerHTML;
            btn.disabled = true; 
            btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('loading-text').innerText = "æ­£åœ¨ä¸Šå‚³æˆ°ç¸¾...";

            const rows = document.querySelectorAll('.chip-input');
            const payload = [];
            const nextBaseChips = {}; 
            
            gameState.players.forEach((name, idx) => {
                const base = gameState.baseChips[name];
                const topUp = gameState.topUps[name] || 0;
                const effectiveBase = base + topUp; 
                const inputVal = parseInt(rows[idx].value) || 0;
                const score = inputVal - effectiveBase; 
                nextBaseChips[name] = inputVal; 
                
                const e = gameState.extras[name] || { penalty: 0, foul: 0, continuance: 0, bigHands: [] };
                
                payload.push({ 
                    name: name, 
                    score: score, 
                    topUp: topUp,
                    continuance: e.continuance, 
                    penalty: e.penalty, 
                    foul: e.foul, 
                    bigCount: e.bigHands.length, 
                    bigNames: e.bigHands.join(',') 
                });
            });

            const currentFund = parseInt(document.getElementById('current-fund').value) || 0;
            const fundDiff = currentFund - gameState.baseFund;

            try {
                const dateStr = gameState.sessionDate || new Date().toISOString().split('T')[0];
                
                await fetch(API_URL, {
                    method: 'POST', mode: 'no-cors',
                    body: JSON.stringify({ date: dateStr, round: gameState.round, fund: fundDiff, data: payload })
                });

                gameState.history.push({ round: gameState.round, scores: payload, fund: fundDiff });
                gameState.round += 1;
                gameState.baseChips = nextBaseChips;
                gameState.baseFund = currentFund;
                gameState.topUps = {}; // æ¸…ç©ºå¢è²¸ç´€éŒ„
                gameState.extras = {}; 
                saveState();
                renderGameView();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (e) { 
                console.error(e);
                alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯"); 
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        // --- Banner & Views ---
        function startBannerCarousel() {
            const slides = document.querySelectorAll('.banner-slide');
            if (slides.length < 2) return;
            let currentIndex = 0;
            setInterval(() => {
                slides[currentIndex].classList.replace('opacity-100', 'opacity-0');
                currentIndex = (currentIndex + 1) % slides.length;
                slides[currentIndex].classList.replace('opacity-0', 'opacity-100');
            }, 3000);
        }

        function showLobby() {
            document.getElementById('view-lobby').classList.remove('hidden');
            document.getElementById('view-game').classList.add('hidden');
            renderLobbyPlayers();
        }

        // --- Lobby Funcs ---
        function addNewPlayer() {
            const newName = prompt("è«‹è¼¸å…¥æ–°ç©å®¶çš„åå­—ï¼š");
            if (newName && newName.trim() !== "") {
                if (allPlayers.includes(newName)) { alert("å·²å­˜åœ¨"); return; }
                allPlayers.push(newName);
                localStorage.setItem('mj_all_players', JSON.stringify(allPlayers));
                renderLobbyPlayers();
            }
        }
        function renderLobbyPlayers() {
            const container = document.getElementById('lobby-players');
            let lastPlayers = JSON.parse(localStorage.getItem('mj_last_players')) || DEFAULT_PLAYERS.slice(0, 4);
            container.innerHTML = Array(4).fill(0).map((_, i) => {
                const currentPlayer = lastPlayers[i] || allPlayers[0];
                const options = allPlayers.map(p => `<option value="${p}" ${p === currentPlayer ? 'selected' : ''}>${p}</option>`).join('');
                return `<div class="relative group"><div class="w-full aspect-square bg-cute-cream rounded-2xl border-2 border-cute-red/20 flex flex-col items-center justify-center relative overflow-hidden group-hover:border-cute-red transition shadow-sm active:scale-95"><div class="w-12 h-12 rounded-full bg-cute-red text-white flex items-center justify-center text-xl font-black mb-1 shadow-md border-2 border-white">${currentPlayer.charAt(0)}</div><select onchange="updateLobbyPlayer(this, ${i})" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full text-center">${options}</select><span class="text-sm font-bold text-cute-dark pointer-events-none player-name-display">${currentPlayer}</span><i class="fa-solid fa-caret-down text-[10px] text-cute-red/30 absolute bottom-1"></i></div></div>`;
            }).join('');
        }
        function updateLobbyPlayer(select, index) {
            const displayEl = select.parentElement.querySelector('.player-name-display');
            displayEl.innerText = select.value;
            select.parentElement.querySelector('div').innerText = select.value.charAt(0);
            let lastPlayers = JSON.parse(localStorage.getItem('mj_last_players')) || DEFAULT_PLAYERS.slice(0, 4);
            lastPlayers[index] = select.value;
            localStorage.setItem('mj_last_players', JSON.stringify(lastPlayers));
        }

        // --- Core Helpers ---
    function calculate() {
                const inputs = document.querySelectorAll('.chip-input');
                let totalScoreDiff = 0;
    
                // 1. è¨ˆç®—æ¯å€‹äººçš„è¼¸è´
                inputs.forEach((input, idx) => {
                    const name = gameState.players[idx];
                    const base = gameState.baseChips[name];
                    const topUp = gameState.topUps[name] || 0;
                    const effectiveBase = base + topUp;
                    const val = parseInt(input.value);
                    const diffEl = input.previousElementSibling;
                    
                    if (isNaN(val)) { diffEl.innerText = "..."; return; }
                    
                    const diff = val - effectiveBase;
                    totalScoreDiff += diff;
                    
                    diffEl.innerText = diff > 0 ? `+${diff}` : diff;
                    diffEl.className = `text-base font-bold w-8 text-right score-diff ${diff > 0 ? 'text-cute-red' : (diff < 0 ? 'text-green-600' : 'text-gray-300')}`;
                });
    
                // 2. åŠ å…¥å…¬åŸºé‡‘è®Šå‹•
                const fVal = parseInt(document.getElementById('current-fund').value) || 0;
                totalScoreDiff += (fVal - gameState.baseFund);
                document.getElementById('fund-diff').innerText = `è®Šå‹•: ${(fVal - gameState.baseFund)}`;
    
                // 3. é¡¯ç¤ºçµæœ (ä¿®æ”¹é€™é‚Š)
                const checkEl = document.getElementById('check-sum');
                const subBtn = document.getElementById('submit-btn');
    
                if (totalScoreDiff === 0) {
                    // å¹³è¡¡æ™‚é¡¯ç¤ºç¶ è‰²å‹¾å‹¾
                    checkEl.innerHTML = `<i class="fa-solid fa-check text-green-500"></i>`;
                    subBtn.disabled = false; 
                    subBtn.className = "btn-push flex-[2] bg-cute-red text-white font-black py-4 rounded-2xl shadow-lg transition text-2xl"; 
                } else {
                    // ä¸å¹³è¡¡æ™‚ï¼Œé¡¯ç¤ºä¸­æ–‡æç¤º
                    const msg = totalScoreDiff > 0 
                        ? `æœ‰äººå¤šç®— ${totalScoreDiff}` 
                        : `æœ‰äººå°‘ç®— ${Math.abs(totalScoreDiff)}`;
    
                    // ä½¿ç”¨ text-base ç¨å¾®ç¸®å°å­—é«”ï¼Œç¢ºä¿æ‰‹æ©Ÿèƒ½å®Œæ•´é¡¯ç¤º
                    checkEl.innerHTML = `<span class="text-cute-red font-black text-lg">${msg}</span>`;
                    
                    subBtn.disabled = true; 
                    subBtn.className = "flex-[2] bg-gray-300 text-white font-black py-4 rounded-2xl shadow-sm cursor-not-allowed text-2xl"; 
                }
            }
    
            function renderHistory() {
                const container = document.getElementById('history-container');
                if (gameState.history.length === 0) { container.innerHTML = ''; return; }
                container.innerHTML = gameState.history.map(h => {
                    const winner = h.scores.reduce((p, c) => (p.score > c.score) ? p : c);
                    const winnerText = winner.score > 0 ? `${winner.name} +${winner.score}` : 'å¹³å±€';
                    return `<details class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden group"><summary class="flex justify-between items-center p-3 hover:bg-gray-50 transition select-none"><div class="font-bold text-gray-700 text-base"><span class="bg-gray-100 text-gray-600 px-3 py-1 rounded text-sm mr-2">ç¬¬ ${h.round} é†¬</span><span class="text-cute-red">${winnerText}</span></div><i class="fa-solid fa-chevron-down text-gray-300 group-open:rotate-180 transition-transform text-lg"></i></summary><div class="p-4 bg-cute-cream/50 border-t border-gray-100 text-base grid grid-cols-2 gap-2">${h.scores.map(s => `<div class="flex justify-between"><span class="text-gray-600">${s.name}</span><span class="font-bold ${s.score >= 0 ? 'text-cute-red' : 'text-green-600'}">${s.score > 0 ? '+' : ''}${s.score}</span></div>`).join('')}<div class="flex justify-between border-t border-gray-200 pt-2 mt-1 col-span-2"><span class="text-gray-500">å…¬åŸºé‡‘è®Šå‹•</span><span class="font-bold text-cute-yellow">${h.fund > 0 ? '+' : ''}${h.fund}</span></div></div></details>`;
                }).reverse().join('');
            }

        function saveState() { localStorage.setItem('mj_game_state', JSON.stringify(gameState)); }
        
        // --- Modals Logic (TopUp, Sub, Exit) ---
        function openTopUpModal() {
            const s = document.getElementById('topup-player');
            s.innerHTML = gameState.players.map(p => `<option value="${p}">${p}</option>`).join('');
            document.getElementById('topup-modal').classList.remove('hidden');
        }
        function closeTopUpModal() { document.getElementById('topup-modal').classList.add('hidden'); }
        
        // ä¿®æ”¹ï¼šconfirmTopUp æ”¯æ´å¢è³‡(1) èˆ‡ é‚„æ¬¾(-1)
        function confirmTopUp(multiplier) {
            const p = document.getElementById('topup-player').value;
            const amt = parseInt(document.getElementById('topup-amount').value) || 0;
            if(!gameState.topUps[p]) gameState.topUps[p] = 0;
            
            // ä¹˜ä¸Š multiplier (1 æˆ– -1)
            gameState.topUps[p] += (amt * multiplier);
            
            saveState(); renderGameView(); closeTopUpModal();
        }
        
        function openSubModal(p) {
            editingPlayerName = p;
            document.getElementById('sub-current-player').innerText = p;
            const active = gameState.players.filter(x => x !== p);
            const opts = allPlayers.filter(x => !active.includes(x));
            const sel = document.getElementById('sub-new-player');
            sel.innerHTML = opts.map(x => `<option value="${x}">${x}</option>`).join('');
            if(!opts.includes(p)) sel.innerHTML += `<option value="${p}" selected>${p}</option>`;
            document.getElementById('sub-modal').classList.remove('hidden');
        }
        function closeSubModal() { document.getElementById('sub-modal').classList.add('hidden'); }
        function confirmSubstitution(mode) {
            const oldN = editingPlayerName;
            const newN = document.getElementById('sub-new-player').value;
            const chips = parseInt(document.getElementById('sub-base-chips').value) || 1000;
            const idx = gameState.players.indexOf(oldN);
            gameState.players[idx] = newN;
            if(mode === 'reset') {
                delete gameState.baseChips[oldN]; gameState.baseChips[newN] = chips;
                delete gameState.topUps[oldN]; delete gameState.extras[oldN];
            } else {
                gameState.baseChips[newN] = gameState.baseChips[oldN]; delete gameState.baseChips[oldN];
                if(gameState.topUps[oldN]) { gameState.topUps[newN] = gameState.topUps[oldN]; delete gameState.topUps[oldN]; }
                if(gameState.extras[oldN]) { gameState.extras[newN] = gameState.extras[oldN]; delete gameState.extras[oldN]; }
            }
            localStorage.setItem('mj_last_players', JSON.stringify(gameState.players));
            saveState(); renderGameView(); closeSubModal();
        }

        function startGame() {
            const selects = document.querySelectorAll('#lobby-players select');
            const pList = Array.from(selects).map(s => s.value);
            if (new Set(pList).size !== 4) { alert("ç©å®¶ä¸èƒ½é‡è¤‡å–”ï¼"); return; }
            const initChips = parseInt(document.getElementById('init-chips').value) || 1000;
            
            const d = new Date();
            const sessionDate = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;

            gameState.active = true; 
            gameState.round = 1; 
            gameState.players = pList; 
            gameState.baseChips = {}; 
            gameState.topUps = {}; 
            gameState.extras = {}; 
            gameState.sessionDate = sessionDate; 
            
            pList.forEach(p => gameState.baseChips[p] = initChips);
            gameState.baseFund = 0; 
            gameState.history = [];
            
            localStorage.setItem('mj_last_players', JSON.stringify(pList));
            saveState(); 
            renderGameView();
        }

        // ä¿®æ”¹ï¼šä½¿ç”¨ Modal ä¾†è™•ç†çµæŸç¢ºèªï¼Œé¿å… confirm() è¢«é˜»æ“‹
        function exitGame() { 
            document.getElementById('exit-modal').classList.remove('hidden');
        }

        function closeExitModal() {
             document.getElementById('exit-modal').classList.add('hidden');
        }

        function confirmExit() {
            localStorage.removeItem('mj_game_state'); 
            closeExitModal();
            // é‡ç½®éŠæˆ²ç‹€æ…‹
            gameState = { active: false, round: 1, baseChips: {}, baseFund: 0, history: [], topUps: {}, extras: {} };
            // é‡æ–°åˆå§‹åŒ–
            init(); 
        }

        init();
    </script>
</body>
</html>